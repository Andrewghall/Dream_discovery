// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider        = "prisma-client-js"
  binaryTargets   = ["native", "rhel-openssl-3.0.x"]
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  extensions = [pgvector(map: "vector")]
}

enum WorkshopStatus {
  DRAFT
  DISCOVERY_SENT
  IN_PROGRESS
  COMPLETED
}

enum WorkshopType {
  STRATEGY
  PROCESS
  CHANGE
  TEAM
  CUSTOMER
  INNOVATION
  CULTURE
  CUSTOM
}

enum AttributionPreference {
  NAMED
  ANONYMOUS
}

enum ConversationStatus {
  IN_PROGRESS
  PAUSED
  COMPLETED
}

enum MessageRole {
  AI
  PARTICIPANT
}

enum InsightType {
  ACTUAL_JOB
  WHAT_WORKS
  CHALLENGE
  CONSTRAINT
  VISION
  BELIEF
  RATING
}

enum InsightCategory {
  BUSINESS
  TECHNOLOGY
  PEOPLE
  CUSTOMER
  REGULATION
}

enum TranscriptSource {
  ZOOM
  DEEPGRAM
  WHISPER
}

enum DataPointSource {
  SPEECH
  MANUAL
}

enum DataPointPrimaryType {
  VISIONARY
  OPPORTUNITY
  CONSTRAINT
  RISK
  ENABLER
  ACTION
  QUESTION
  INSIGHT
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workshops Workshop[]
  users     User[]

  @@map("organizations")
}

model User {
  id             String   @id @default(cuid())
  email          String   @unique
  name           String
  organizationId String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization      Organization @relation(fields: [organizationId], references: [id])
  createdWorkshops  Workshop[]

  @@map("users")
}

model Workshop {
  id               String         @id @default(cuid())
  organizationId   String
  name             String
  description      String?
  businessContext  String?
  includeRegulation Boolean       @default(true)
  workshopType     WorkshopType   @default(CUSTOM)
  status           WorkshopStatus @default(DRAFT)
  zoomMeetingId    String?
  createdById      String
  scheduledDate    DateTime?
  responseDeadline DateTime?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  organization Organization              @relation(fields: [organizationId], references: [id])
  createdBy    User                      @relation(fields: [createdById], references: [id])
  participants WorkshopParticipant[]
  sessions     ConversationSession[]
  insights     ConversationInsight[]
  themes       DiscoveryTheme[]
  transcriptChunks TranscriptChunk[]
  dataPoints       DataPoint[]

  @@map("workshops")
}

model TranscriptChunk {
  id          String          @id @default(cuid())
  workshopId  String
  speakerId   String?
  startTimeMs Int
  endTimeMs   Int
  text        String
  confidence  Float?
  source      TranscriptSource
  createdAt   DateTime        @default(now())

  workshop  Workshop  @relation(fields: [workshopId], references: [id], onDelete: Cascade)
  dataPoint DataPoint?

  @@map("transcript_chunks")
}

model DataPoint {
  id               String         @id @default(cuid())
  workshopId       String
  transcriptChunkId String?       @unique
  rawText          String
  source           DataPointSource
  speakerId        String?
  createdAt        DateTime       @default(now())

  workshop        Workshop        @relation(fields: [workshopId], references: [id], onDelete: Cascade)
  transcriptChunk TranscriptChunk? @relation(fields: [transcriptChunkId], references: [id], onDelete: SetNull)
  classification  DataPointClassification?

  @@map("data_points")
}

model DataPointClassification {
  id            String              @id @default(cuid())
  dataPointId   String              @unique
  primaryType   DataPointPrimaryType
  confidence    Float?
  keywords      String[]
  suggestedArea String?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  dataPoint DataPoint @relation(fields: [dataPointId], references: [id], onDelete: Cascade)

  @@map("data_point_classifications")
}

model WorkshopParticipant {
  id                     String                @id @default(cuid())
  workshopId             String
  email                  String
  name                   String
  role                   String?
  department             String?
  discoveryToken         String                @unique @default(cuid())
  attributionPreference  AttributionPreference @default(NAMED)
  emailSentAt            DateTime?
  responseStartedAt      DateTime?
  responseCompletedAt    DateTime?
  reminderSentAt         DateTime?
  createdAt              DateTime              @default(now())

  workshop Workshop              @relation(fields: [workshopId], references: [id], onDelete: Cascade)
  sessions ConversationSession[]
  insights ConversationInsight[]

  @@map("workshop_participants")
}

model ConversationSession {
  id                String             @id @default(cuid())
  workshopId        String
  participantId     String
  status            ConversationStatus @default(IN_PROGRESS)
  currentPhase      String             @default("intro")
  phaseProgress     Int                @default(0)
  language          String             @default("en")
  voiceEnabled      Boolean            @default(false)
  includeRegulation Boolean            @default(true)
  startedAt         DateTime           @default(now())
  completedAt       DateTime?
  totalDurationMs   Int?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  workshop    Workshop              @relation(fields: [workshopId], references: [id], onDelete: Cascade)
  participant WorkshopParticipant   @relation(fields: [participantId], references: [id], onDelete: Cascade)
  messages    ConversationMessage[]
  insights    ConversationInsight[]

  @@map("conversation_sessions")
}

model ConversationMessage {
  id        String      @id @default(cuid())
  sessionId String
  role      MessageRole
  content   String
  phase     String?
  metadata  Json?
  createdAt DateTime    @default(now())

  session ConversationSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("conversation_messages")
}

model ConversationInsight {
  id                String           @id @default(cuid())
  sessionId         String
  workshopId        String
  participantId     String
  insightType       InsightType
  category          InsightCategory?
  text              String
  severity          Int?
  impact            String?
  sourceMessageIds  String[]
  confidence        Float            @default(0.8)
  embedding         Unsupported("vector(1536)")?
  createdAt         DateTime         @default(now())

  session     ConversationSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  workshop    Workshop            @relation(fields: [workshopId], references: [id], onDelete: Cascade)
  participant WorkshopParticipant @relation(fields: [participantId], references: [id], onDelete: Cascade)

  @@map("conversation_insights")
}

model DiscoveryTheme {
  id               String   @id @default(cuid())
  workshopId       String
  themeLabel       String
  themeDescription String?
  participantCount Int      @default(0)
  responseIds      String[]
  confidence       Float    @default(0.8)
  modelVersion     String?
  createdAt        DateTime @default(now())

  workshop Workshop @relation(fields: [workshopId], references: [id], onDelete: Cascade)

  @@map("discovery_themes")
}
